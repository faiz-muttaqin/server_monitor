
<style>
    .device-status-online {
        color: #198754;
    }
    
    .device-status-offline {
        color: #dc3545;
    }
    
    .status-card {
        transition: transform 0.2s;
    }
    
    .status-card:hover {
        transform: translateY(-2px);
    }
/*     
    .nav-pills .nav-link {
        color: #ffffff;
        border-radius: 0.375rem;
        margin-right: 0.5rem;
    }
    
    .nav-pills .nav-link.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .table-hover tbody tr:hover {
        background-color: rgba(102, 126, 234, 0.1);
    }
    
    .badge-port {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .loading-spinner {
        display: inline-block;
        width: 1rem;
        height: 1rem;
    }
    
    .card-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    
    .refresh-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
    }
    
    .refresh-btn:hover {
        background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        border: none;
    } */
    
    .toggle-btn {
        background: #6c757d;
        border: none;
        transition: all 0.3s ease;
    }
    
    .toggle-btn:hover {
        background: #5a6268;
        border: none;
    }
    
    .toggle-btn.active {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        border: none;
    }
    
    .toggle-btn.active:hover {
        background: linear-gradient(135deg, #218838 0%, #1fa87a 100%);
        border: none;
    }
    
    /* DataTables Custom Styling */
    .dataTables_wrapper .dataTables_length,
    .dataTables_wrapper .dataTables_filter,
    .dataTables_wrapper .dataTables_info,
    .dataTables_wrapper .dataTables_paginate {
        margin-bottom: 0.5rem;
    }
    
    .dataTables_wrapper .dataTables_length select,
    .dataTables_wrapper .dataTables_filter input {
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        padding: 0.375rem 0.75rem;
    }
    
    .dataTables_wrapper .dataTables_paginate .paginate_button {
        padding: 0.375rem 0.75rem;
        margin: 0 0.125rem;
        border-radius: 0.375rem;
    }
    
    .dataTables_wrapper .dataTables_paginate .paginate_button.current {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-color: #667eea;
        color: white !important;
    }
    
    .nat-rules-table {
        font-size: 0.875rem;
    }
    
    .nat-rules-table th {
        background-color: #f8f9fa;
        border-top: none;
        font-weight: 600;
    }
    
    /* DataTables Buttons */
    .dt-buttons {
        margin-bottom: 0.5rem;
    }
    
    .dt-buttons .btn {
        margin-right: 0.25rem;
        font-size: 0.875rem;
    }
</style>
<div class="">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col">
            <div class="card text-white" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <div class="card-body text-center">
                    <h1 class="card-title mb-2">
                        <i class="bi bi-router"></i> Multi-Device MikroTik Monitor
                    </h1>
                    <p class="card-text">Real-time monitoring of NAT rules and network connections across multiple devices</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Refresh Controls -->
    <div class="row mb-3">
        <div class="col">
            <div class="d-flex align-items-center gap-2">
                <button class="btn btn-primary refresh-btn" onclick="refreshAll()">
                    <i class="bi bi-arrow-clockwise"></i> Refresh All
                </button>
                <button class="btn toggle-btn text-white" id="auto-refresh-toggle" onclick="toggleAutoRefresh()">
                    <i class="bi bi-pause-circle"></i> Auto Refresh: OFF
                </button>
                <small class="text-muted ms-2">Last updated: <span id="last-refresh">Loading...</span></small>
            </div>
        </div>
    </div>

    <!-- Device Navigation Pills -->
    <div class="row mb-4">
        <div class="col">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-hdd-network"></i> Connected Devices</h5>
                </div>
                <div class="card-body">
                    <div id="device-loading" class="text-center py-3">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading devices...</span>
                        </div>
                        <p class="mt-2 text-muted">Loading device configurations...</p>
                    </div>
                    
                    <div id="device-navigation" style="display: none;">
                        <ul class="nav nav-pills mb-3" id="device-pills" role="tablist">
                            <!-- Device tabs will be populated here -->
                        </ul>
                        <div class="tab-content-network" id="mikrotik-device-content">
                            <!-- Device content will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Global Health Status -->
    <div class="row mb-4">
        <div class="col">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-heart-pulse"></i> System Health</h5>
                </div>
                <div class="card-body">
                    <div class="row" id="global-health">
                        <div class="col-md-3">
                            <div class="card status-card border-0 bg-light">
                                <div class="card-body text-center">
                                    <h3 class="text-primary" id="total-devices">-</h3>
                                    <small class="text-muted">Total Devices</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card status-card border-0 bg-light">
                                <div class="card-body text-center">
                                    <h3 class="text-success" id="online-devices">-</h3>
                                    <small class="text-muted">Online Devices</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card status-card border-0 bg-light">
                                <div class="card-body text-center">
                                    <h3 class="text-info" id="total-nat-rules">-</h3>
                                    <small class="text-muted">Total NAT Rules</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card status-card border-0 bg-light">
                                <div class="card-body text-center">
                                    <h3 class="text-warning" id="total-connections">-</h3>
                                    <small class="text-muted">Total Connections</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Service Detail Modal -->
<div class="modal fade" id="serviceDetailModal" tabindex="-1" aria-labelledby="serviceDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="serviceDetailModalLabel">
                    <i class="bi bi-gear me-2"></i>Service Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <!-- Service Information -->
                    <div class="col-md-6">
                        <div class="card border-0 bg-light">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0"><i class="bi bi-info-circle me-1"></i>Service Information</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Service Name:</label>
                                    <div id="modal-service-name" class="text-break"></div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Type:</label>
                                    <div id="modal-service-type"></div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Status:</label>
                                    <div id="modal-service-status"></div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Started At:</label>
                                    <div id="modal-service-started" class="text-muted"></div>
                                </div>
                                <div class="mb-0">
                                    <label class="form-label fw-bold">Path:</label>
                                    <div id="modal-service-path" class="text-break text-muted"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- NAT Rule Information -->
                    <div class="col-md-6">
                        <div class="card border-0 bg-light">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0"><i class="bi bi-arrow-right me-1"></i>NAT Rule Information</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">External Port:</label>
                                    <div id="modal-dst-port"></div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Internal Target:</label>
                                    <div id="modal-to-address"></div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Chain:</label>
                                    <div id="modal-chain"></div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Comment:</label>
                                    <div id="modal-comment" class="text-muted"></div>
                                </div>
                                <div class="mb-0">
                                    <label class="form-label fw-bold">Rule ID:</label>
                                    <div id="modal-rule-id" class="text-muted"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Service Description -->
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="card border-0 bg-light">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0"><i class="bi bi-file-text me-1"></i>Description</h6>
                            </div>
                            <div class="card-body">
                                <div id="modal-service-description" class="text-muted">
                                    No description available
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i>Close
                </button>
                <button type="button" class="btn btn-primary" onclick="copyServiceInfo()">
                    <i class="bi bi-clipboard me-1"></i>Copy Info
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    const API_BASE = '/api/v1';
    let devices = [];
    let refreshInterval;
    let activeDeviceId = null;
    let isAutoRefreshEnabled = false;
    let dataTables = {}; // Store DataTable instances

    async function fetchJSON(endpoint) {
        try {
            const response = await fetch(API_BASE + endpoint);
            const data = await response.json();
            if (!data.success) {
                throw new Error(data.error || 'API request failed');
            }
            return data.data;
        } catch (error) {
            console.error('Fetch error:', error);
            throw error;
        }
    }

    async function loadDevices() {
        try {
            devices = await fetchJSON('/devices');
            console.log('Loaded devices:', devices);
            createDeviceNavigation();
            document.getElementById('device-loading').style.display = 'none';
            document.getElementById('device-navigation').style.display = 'block';
        } catch (error) {
            console.error('Failed to load devices:', error);
            document.getElementById('device-loading').innerHTML = `
                <div class="alert alert-danger" role="alert">
                    <i class="bi bi-exclamation-triangle"></i> Failed to load device configurations: ${error.message}
                </div>
            `;
        }
    }

    function createDeviceNavigation() {
        const pillsContainer = document.getElementById('device-pills');
        const contentContainer = document.getElementById('mikrotik-device-content');
        
        pillsContainer.innerHTML = '';
        contentContainer.innerHTML = '';

        devices.forEach((device, index) => {
            const isActive = index === 0;
            if (isActive) activeDeviceId = device.id;

            // Create nav pill
            const pill = document.createElement('li');
            pill.className = 'nav-item';
            pill.innerHTML = `
                <button class="nav-link ${isActive ? 'active' : ''}" 
                        id="device-${device.id}-tab" 
                        data-bs-toggle="pill" 
                        data-bs-target="#device-${device.id}" 
                        type="button" 
                        role="tab" 
                        aria-controls="device-${device.id}" 
                        aria-selected="${isActive}"
                        onclick="setActiveDevice('${device.id}')">
                    <i class="bi bi-router me-1"></i>
                    ${device.name}
                    <span class="badge ms-2" id="status-badge-${device.id}">
                        <i class="bi bi-circle-fill"></i>
                    </span>
                </button>
            `;
            pillsContainer.appendChild(pill);

            // Create content pane
            const content = document.createElement('div');
            content.className = `tab-pane fade ${isActive ? 'show active' : ''}`;
            content.id = `device-${device.id}`;
            content.setAttribute('role', 'tabpanel');
            content.setAttribute('aria-labelledby', `device-${device.id}-tab`);
            content.innerHTML = createDeviceContent(device);
            contentContainer.appendChild(content);
        });
    }

    function createDeviceContent(device) {
        return `
            <div class="row mb-4">
                <!-- Device Status Cards -->
                <div class="col-md-3">
                    <div class="card status-card border-0 bg-light">
                        <div class="card-body text-center">
                            <div id="device-${device.id}-status">
                                <i class="bi bi-circle device-status-offline"></i>
                                <span class="ms-1">Checking...</span>
                            </div>
                            <small class="text-muted">Connection Status</small>
                            <div class="mt-1">
                                <small class="text-muted">${device.host}</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card status-card border-0 bg-light">
                        <div class="card-body text-center">
                            <h4 class="text-primary" id="device-${device.id}-nat-count">-</h4>
                            <small class="text-muted">NAT Rules</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card status-card border-0 bg-light">
                        <div class="card-body text-center">
                            <h4 class="text-success" id="device-${device.id}-connections">-</h4>
                            <small class="text-muted">Active Connections</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card status-card border-0 bg-light">
                        <div class="card-body text-center">
                            <div id="device-${device.id}-uptime" class="fw-bold">-</div>
                            <small class="text-muted">Uptime</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- NAT Rules Table -->
            <div >
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-list-ul"></i> NAT Rules - ${device.name}
                    </h5>
                </div>
                <div class="card-body">
                    <div id="device-${device.id}-nat-rules">
                        <div class="text-center py-3" id="loading-${device.id}">
                            <div class="spinner-border text-primary loading-spinner" role="status">
                                <span class="visually-hidden">Loading NAT rules...</span>
                            </div>
                            <p class="mt-2 text-muted">Loading NAT rules...</p>
                        </div>
                        <table id="nat-table-${device.id}" class="table table-striped table-hover nat-rules-table" style="display: none;">
                            <thead>
                                <tr>
                                    <th class="bg-transparent"><i class="bx bx-category"></i> Service</th>
                                    <th class="bg-transparent"><i class="bi bi-arrow-right"></i> Forward To</th>
                                    <th class="bg-transparent"><i class="bi bi-globe"></i> Destination</th>
                                    <th class="bg-transparent"><i class="bi bi-outlet"></i> Port</th>
                                    <th class="bg-transparent"><i class="bi bi-link"></i> Chain</th>
                                    <th class="bg-transparent"><i class="bi bi-chat-text"></i> Comment</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
    }

    function setActiveDevice(deviceId) {
        activeDeviceId = deviceId;
        updateDeviceData(deviceId);
        
        // Trigger DataTable responsive recalculation after tab switch
        setTimeout(() => {
            if (dataTables[deviceId]) {
                dataTables[deviceId].columns.adjust().responsive.recalc();
            }
        }, 100);
    }

    async function updateGlobalHealth() {
        try {
            const health = await fetchJSON('/health');
            document.getElementById('total-devices').textContent = health.total_devices || 0;
            document.getElementById('online-devices').textContent = health.online_devices || 0;
            
            const status = await fetchJSON('/status');
            let totalNatRules = 0;
            let totalConnections = 0;
            
            for (const deviceId in status.devices) {
                const deviceStatus = status.devices[deviceId];
                totalNatRules += deviceStatus.total_nat_rules || 0;
                totalConnections += deviceStatus.active_connections || 0;
            }
            
            document.getElementById('total-nat-rules').textContent = totalNatRules;
            document.getElementById('total-connections').textContent = totalConnections;
            
        } catch (error) {
            console.error('Failed to update global health:', error);
        }
    }

    async function updateDeviceData(deviceId) {
        try {
            // Update device status
            const status = await fetchJSON(`/devices/${deviceId}/status`);
            updateDeviceStatus(deviceId, status);
            
            // Update NAT rules
            const natRules = await fetchJSON(`/devices/${deviceId}/nat-rules`);
            updateDeviceNATRules(deviceId, natRules);
            
        } catch (error) {
            console.error(`Failed to update device ${deviceId}:`, error);
            updateDeviceStatus(deviceId, null, error.message);
            
            // Show error in NAT rules table
            const loadingElement = document.getElementById(`loading-${deviceId}`);
            if (loadingElement) {
                loadingElement.innerHTML = `
                    <div class="alert alert-danger" role="alert">
                        <i class="bi bi-exclamation-triangle"></i> Failed to load NAT rules: ${error.message}
                    </div>
                `;
            }
        }
    }

    function updateDeviceStatus(deviceId, status, error = null) {
        const statusEl = document.getElementById(`device-${deviceId}-status`);
        const natCountEl = document.getElementById(`device-${deviceId}-nat-count`);
        const connectionsEl = document.getElementById(`device-${deviceId}-connections`);
        const uptimeEl = document.getElementById(`device-${deviceId}-uptime`);
        const badgeEl = document.getElementById(`status-badge-${deviceId}`);

        if (error) {
            statusEl.innerHTML = `<i class="bi bi-x-circle device-status-offline"></i><span class="ms-1">Error</span>`;
            badgeEl.className = 'badge bg-danger ms-2';
            badgeEl.innerHTML = '<i class="bi bi-x-circle-fill"></i>';
            natCountEl.textContent = '-';
            connectionsEl.textContent = '-';
            uptimeEl.textContent = '-';
            return;
        }

        if (status && status.is_running) {
            statusEl.innerHTML = `<i class="bi bi-check-circle device-status-online"></i><span class="ms-1">Connected</span>`;
            badgeEl.className = 'badge bg-success ms-2';
            badgeEl.innerHTML = '<i class="bi bi-check-circle-fill"></i>';
            natCountEl.textContent = status.total_nat_rules || 0;
            connectionsEl.textContent = status.active_connections || 0;
            uptimeEl.textContent = status.uptime || '-';
        } else {
            statusEl.innerHTML = `<i class="bi bi-x-circle device-status-offline"></i><span class="ms-1">Disconnected</span>`;
            badgeEl.className = 'badge bg-danger ms-2';
            badgeEl.innerHTML = '<i class="bi bi-x-circle-fill"></i>';
            natCountEl.textContent = '-';
            connectionsEl.textContent = '-';
            uptimeEl.textContent = '-';
        }
    }

    function updateDeviceNATRules(deviceId, rules) {
        const loadingElement = document.getElementById(`loading-${deviceId}`);
        const tableElement = document.getElementById(`nat-table-${deviceId}`);
        
        // Hide loading spinner
        if (loadingElement) {
            loadingElement.style.display = 'none';
        }
        
        if (!rules || rules.length === 0) {
            // Destroy existing DataTable if exists
            if (dataTables[deviceId]) {
                dataTables[deviceId].destroy();
                delete dataTables[deviceId];
            }
            
            // Show no data message
            const container = document.getElementById(`device-${deviceId}-nat-rules`);
            container.innerHTML = `
                <div class="alert alert-info" role="alert">
                    <i class="bi bi-info-circle"></i> No NAT rules found for this device.
                </div>
            `;
            return;
        }

        // Show table
        tableElement.style.display = 'table';
        
        // Destroy existing DataTable if exists
        if (dataTables[deviceId]) {
            dataTables[deviceId].destroy();
        }
        
        // Prepare data for DataTable
        const tableData = rules.map(rule => {
            let serviceDisplay = '';
            
            // Handle different service states
            if (rule.service_name === 'not found') {
                serviceDisplay = '<span class="text-danger"><i class="bi bi-x-circle"></i> ‚ùå no app running on this port</span>';
            } else if (!rule.service_name || String(rule.service_name).trim() === '' || String(rule.service_name).toLowerCase() === 'unreachable') {
                serviceDisplay = '<span class="text-muted"><i class="bi bi-question-circle"></i> unreachable</span>';
            } else if (/^(alive|timeout)\s*:\s*(.+)$/i.test(String(rule.service_name).trim())) {
                const parts = String(rule.service_name).trim().match(/^(alive|timeout)\s*:\s*(.+)$/i);
                const state = (parts[1] || '').toLowerCase();
                const timeRaw = (parts[2] || '').trim();

                // Try to parse the timestamp (common form: YYYY/MM/DD HH:MM:SS)
                let parsed = new Date(timeRaw.replace(/\//g, '-'));
                let displayTime = timeRaw;
                if (!isNaN(parsed.getTime())) {
                    displayTime = parsed.toLocaleString();
                }

                const icon = state === 'alive' ? 'bi-check-circle' : 'bi-exclamation-triangle';
                const colorClass = state === 'alive' ? 'text-success' : 'text-danger';
                const label = state === 'alive' ? 'Alive' : 'Timeout';

                serviceDisplay = `<span class="text-muted"><i class="bi ${icon} ${colorClass}"></i> ${label} <br> <code class="ms-1">${displayTime}</code></span>`;
            } else {
                // For actual services, create clickable button
                const ruleDataJson = JSON.stringify(rule).replace(/"/g, '&quot;');
                const serviceIcon = rule.is_service ? 'bi-gear' : 'bi-cpu';
                const serviceType = rule.is_service ? 'Service' : 'Process';
                const statusClass = rule.service_status === 'active' || rule.service_status === 'running' ? 'text-success' : 'text-warning';
                
                serviceDisplay = `
                    <button type="button" 
                            class="btn btn-sm btn-outline-success d-flex align-items-center" 
                            onclick="showServiceDetail(${ruleDataJson})"
                            title="Click to view ${serviceType.toLowerCase()} details">
                        <i class="bi ${serviceIcon} me-1"></i>
                        <span class="text-truncate" style="max-width: 120px;">${rule.service_name}</span>
                        <i class="bi bi-info-circle ms-1 ${statusClass}"></i>
                    </button>
                `;
            }
            
            return [
                serviceDisplay,
                `<code>${rule.to_address || '-'}:${rule.to_port || '-'}</code>`,
                `<code>${rule.dst_address || '-'}</code>`,
                `${rule.dst_port ? String(rule.dst_port).split(',').map(p => p.trim()).filter(Boolean).map(p => `<h4 class="fw-medium me-1">${p}</h4>`).join('<br/>') : '<span class="badge badge-port text-white">-</span>'}`,
                `<span class="badge ${rule.chain == 'dstnat' ? 'bg-info' : 'bg-secondary'}">${rule.chain || '-'}</span>`,
                `<small class="text-muted">${rule.comment || '-'}</small>`
            ];
        });
        
        // Initialize DataTable
        dataTables[deviceId] = $(`#nat-table-${deviceId}`).DataTable({
            data: tableData,
            responsive: true,
            pageLength: -1,
            lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
            order: [[4, 'desc']], // Sort by destination address
            buttons: [
                {
                    extend: 'copy',
                    className: 'btn btn-secondary btn-sm',
                    text: '<i class="bi bi-clipboard"></i> Copy'
                },
                {
                    extend: 'csv',
                    className: 'btn btn-success btn-sm',
                    text: '<i class="bi bi-file-earmark-spreadsheet"></i> CSV',
                    filename: `nat-rules-${deviceId}-${new Date().toISOString().split('T')[0]}`
                },
                {
                    extend: 'excel',
                    className: 'btn btn-success btn-sm',
                    text: '<i class="bi bi-file-earmark-excel"></i> Excel',
                    filename: `nat-rules-${deviceId}-${new Date().toISOString().split('T')[0]}`
                }
            ],
            language: {
                search: "Search NAT Rules:",
                lengthMenu: "Show _MENU_ rules per page",
                info: "Showing _START_ to _END_ of _TOTAL_ NAT rules",
                infoEmpty: "No NAT rules available",
                infoFiltered: "(filtered from _MAX_ total rules)",
                paginate: {
                    first: "First",
                    last: "Last",
                    next: "Next",
                    previous: "Previous"
                }
            },
            dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>' +
                    '<"row"<"col-sm-12 col-md-6"B><"col-sm-12 col-md-6">>' +
                    '<"row"<"col-sm-12"tr>>' +
                    '<"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
            columnDefs: [
                { targets: [0, 2], orderable: true, searchable: false }, // Chain and Port columns
                { targets: [1, 3, 4], orderable: true, searchable: true }, // Destination, Forward To, Comment columns
                // { width: "15%", targets: 0 }, // Chain
                // { width: "20%", targets: 1 }, // Destination
                // { width: "12%", targets: 2 }, // Port
                // { width: "20%", targets: 3 }, // Forward To
                // { width: "33%", targets: 4 }  // Comment
            ],
            initComplete: function () {
                // Add a small info badge showing total rules
                const info = this.api().page.info();
                console.log(`DataTable initialized for device ${deviceId} with ${info.recordsTotal} NAT rules`);
            }
        });
    }

    async function updateAllDevices() {
        for (const device of devices) {
            await updateDeviceData(device.id);
        }
    }

    async function refreshAll() {
        document.getElementById('last-refresh').textContent = 'Refreshing...';
        
        try {
            await Promise.all([
                updateGlobalHealth(),
                updateAllDevices()
            ]);
            
            document.getElementById('last-refresh').textContent = new Date().toLocaleTimeString();
        } catch (error) {
            console.error('Refresh failed:', error);
            document.getElementById('last-refresh').textContent = 'Refresh failed';
        }
    }

    function toggleAutoRefresh() {
        const toggleBtn = document.getElementById('auto-refresh-toggle');
        
        if (isAutoRefreshEnabled) {
            // Turn off auto refresh
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
            isAutoRefreshEnabled = false;
            toggleBtn.classList.remove('active');
            toggleBtn.innerHTML = '<i class="bi bi-pause-circle"></i> Auto Refresh: OFF';
        } else {
            // Turn on auto refresh
            refreshInterval = setInterval(refreshAll, 5000);
            isAutoRefreshEnabled = true;
            toggleBtn.classList.add('active');
            toggleBtn.innerHTML = '<i class="bi bi-play-circle"></i> Auto Refresh: ON';
        }
    }

    // Service Detail Modal Functions
    function showServiceDetail(rule) {
        // Update modal title with service type
        const modalTitle = document.getElementById('serviceDetailModalLabel');
        const serviceIcon = rule.is_service ? 'bi-gear' : 'bi-cpu';
        const serviceType = rule.is_service ? 'Service' : 'Process';
        modalTitle.innerHTML = `<i class="bi ${serviceIcon} me-2"></i>${serviceType} Details`;
        
        // Populate service information
        document.getElementById('modal-service-name').textContent = rule.service_name || 'N/A';
        
        // Service type with icon
        const typeElement = document.getElementById('modal-service-type');
        if (rule.is_service) {
            typeElement.innerHTML = '<span class="badge bg-primary"><i class="bi bi-gear me-1"></i>System Service</span>';
        } else {
            typeElement.innerHTML = '<span class="badge bg-info"><i class="bi bi-cpu me-1"></i>Process</span>';
        }
        
        // Service status with color coding
        const statusElement = document.getElementById('modal-service-status');
        const status = rule.service_status || 'unknown';
        let statusBadge = '';
        
        switch (status.toLowerCase()) {
            case 'active':
            case 'running':
                statusBadge = '<span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>Active</span>';
                break;
            case 'inactive':
            case 'stopped':
                statusBadge = '<span class="badge bg-danger"><i class="bi bi-x-circle me-1"></i>Inactive</span>';
                break;
            case 'failed':
                statusBadge = '<span class="badge bg-danger"><i class="bi bi-exclamation-triangle me-1"></i>Failed</span>';
                break;
            default:
                statusBadge = '<span class="badge bg-secondary"><i class="bi bi-question-circle me-1"></i>Unknown</span>';
        }
        statusElement.innerHTML = statusBadge;
        
        // Format started date
        const startedElement = document.getElementById('modal-service-started');
        if (rule.service_started_at && rule.service_started_at !== '0001/01/01 00:00:00') {
            const startDate = new Date(rule.service_started_at);
            if (!isNaN(startDate.getTime())) {
                startedElement.innerHTML = `<i class="bi bi-calendar me-1"></i>${startDate.toLocaleString()}`;
            } else {
                startedElement.innerHTML = '<i class="bi bi-question-circle me-1"></i>Unknown';
            }
        } else {
            startedElement.innerHTML = '<i class="bi bi-question-circle me-1"></i>Not available';
        }
        
        // Service path
        const pathElement = document.getElementById('modal-service-path');
        if (rule.service_path) {
            pathElement.innerHTML = `<code>${rule.service_path}</code>`;
        } else {
            pathElement.textContent = 'Not available';
        }
        
        // NAT Rule information
        document.getElementById('modal-dst-port').innerHTML = rule.dst_port ? 
            `<code class="fs-6">${rule.dst_port}</code>` : 'Not specified';
        
        document.getElementById('modal-to-address').innerHTML = 
            `<code class="fs-6">${rule.to_address || 'N/A'}:${rule.to_port || 'N/A'}</code>`;
        
        const chainElement = document.getElementById('modal-chain');
        chainElement.innerHTML = `<span class="badge ${rule.chain === 'dstnat' ? 'bg-info' : 'bg-secondary'}">${rule.chain || 'N/A'}</span>`;
        
        document.getElementById('modal-comment').textContent = rule.comment || 'No comment';
        document.getElementById('modal-rule-id').textContent = rule.id || 'N/A';
        
        // Service description
        const descElement = document.getElementById('modal-service-description');
        if (rule.service_description && rule.service_description.trim()) {
            descElement.textContent = rule.service_description;
            descElement.classList.remove('text-muted');
        } else {
            descElement.textContent = 'No description available';
            descElement.classList.add('text-muted');
        }
        
        // Store rule data for copy function
        window.currentServiceRule = rule;
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('serviceDetailModal'));
        modal.show();
    }
    
    function copyServiceInfo() {
        if (!window.currentServiceRule) return;
        
        const rule = window.currentServiceRule;
        const serviceType = rule.is_service ? 'Service' : 'Process';
        
        const info = `
${serviceType} Information:
- Name: ${rule.service_name || 'N/A'}
- Type: ${serviceType}
- Status: ${rule.service_status || 'Unknown'}
- Started: ${rule.service_started_at && rule.service_started_at !== '0001/01/01 00:00:00' ? rule.service_started_at : 'Not available'}
- Path: ${rule.service_path || 'Not available'}
- Description: ${rule.service_description || 'No description available'}

NAT Rule Information:
- External Port: ${rule.dst_port || 'Not specified'}
- Internal Target: ${rule.to_address || 'N/A'}:${rule.to_port || 'N/A'}
- Chain: ${rule.chain || 'N/A'}
- Rule ID: ${rule.id || 'N/A'}
- Comment: ${rule.comment || 'No comment'}
        `.trim();
        
        navigator.clipboard.writeText(info).then(() => {
            // Show success feedback
            const btn = event.target.closest('button');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="bi bi-check me-1"></i>Copied!';
            btn.classList.replace('btn-primary', 'btn-success');
            
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.classList.replace('btn-success', 'btn-primary');
            }, 2000);
        }).catch(err => {
            console.error('Failed to copy:', err);
            alert('Failed to copy to clipboard');
        });
    }

    // Initialize dashboard
    async function initialize() {
        await loadDevices();
        await refreshAll();
        
        // Auto refresh is disabled by default
        // User needs to click toggle to enable it
    }

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
        if (refreshInterval) {
            clearInterval(refreshInterval);
            refreshInterval = null;
        }
        
        // Destroy all DataTables
        Object.keys(dataTables).forEach(deviceId => {
            if (dataTables[deviceId]) {
                dataTables[deviceId].destroy();
            }
        });
        dataTables = {};
    });

    // Start the dashboard
    initialize();
</script>